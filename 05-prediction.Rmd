
# 予測関数の推定 {#prediction}

## データの導入

```{r}
data("NMES1988",
     package = "AER")

raw <- NMES1988
```

## データ分割

- ここでは5個のデータに分割する。

```{r}
group <- sample(1:5,
                size = nrow(raw),
                replace = TRUE)
```


## OLS

- 線形予測関数$f(X)=\beta_0 + \beta_1X_1+...+\beta_LX_L$を仮定し、最小二乗法にて推定する。

```{r}
fit <- lm(visits ~ .,
          data = raw[group != 1,])

coef(fit)
```

- 予測値の導出

```{r}
Y.hat <- predict(fit,raw)
```

- テストデータへの適合

```{r}
mean((raw$visits - Y.hat)[group == 1]^2)
```

- 訓練データへの適合

```{r}
mean((raw$visits - Y.hat)[group != 1]^2)
```

## LASSO

- glmentパッケージ[@R-glmnet]を利用

```{r}
library(glmnet)

Y <- raw$visits

X <- model.matrix(visits ~ -1 + .,
                  data = raw)

cv <- cv.glmnet(x = X[group != 1,],
                y = Y[group != 1],
                alpha = 1)

fit <- glmnet(x = X[group != 1,],
              y = Y[group != 1],
              alpha = 1,
              lambda = cv$lambda.min)
```

- 予測モデルの確認

```{r}
coef(fit)
```


- 予測値の導出

```{r}
Y.hat <- predict(fit,X)
```

- テストデータへの適合

```{r}
mean((Y - Y.hat)[group == 1]^2)
```

- 訓練データへの適合

```{r}
mean((Y - Y.hat)[group != 1]^2)
```


## Rdige

- 引き続きglmentパッケージ[@R-glmnet]を利用

```{r}
cv <- cv.glmnet(x = X[group != 1,],
                y = Y[group != 1],
                alpha = 0)

fit <- glmnet(x = X[group != 1,],
              y = Y[group != 1],
              alpha = 0,
              lambda = cv$lambda.min)
```

- 予測モデルの確認

```{r}
coef(fit)
```


- 予測値の導出

```{r}
Y.hat <- predict(fit,X)
```

- テストデータへの適合

```{r}
mean((Y - Y.hat)[group == 1]^2)
```

- 訓練データへの適合

```{r}
mean((Y - Y.hat)[group != 1]^2)
```

## Bagging

- rangerパッケージ[@R-ranger]を利用

```{r}
library(ranger)

fit <- ranger(x = X[group != 1,],
              y = Y[group != 1],
              num.trees = 2000,
              mtry = ncol(X))
```

- 予測値の計算

```{r}
Y.hat <- predict(fit,X)$predictions
```


- テストデータへの適合

```{r}
mean((Y - Y.hat)[group == 1]^2)
```

- 訓練データへの適合

```{r}
mean((Y - Y.hat)[group != 1]^2)
```

## Random Forest

- rangerパッケージ[@R-ranger]を利用

```{r}
library(ranger)

fit <- ranger(x = X[group != 1,],
              y = Y[group != 1],
              num.trees = 2000)
```

- 予測値の計算

```{r}
Y.hat <- predict(fit,X)$predictions
```


- テストデータへの適合

```{r}
mean((Y - Y.hat)[group == 1]^2)
```

- 訓練データへの適合

```{r}
mean((Y - Y.hat)[group != 1]^2)
```
