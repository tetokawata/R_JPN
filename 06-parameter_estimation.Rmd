
# パラメータの推定

- （条件付き）平均差を推定する。

- 点推定だけでなく、信頼区間も推定する。

## データ

```{r}
data("NMES1988",
     package = "AER")

raw <- NMES1988
```

## 部分線形モデルに基づく推定

- 部分線形モデルに関心のあるパラメータを埋め込む

$$E[Y|D=d,X=x]=\underbrace{\tau(x)}_{Interest}\times d+\underbrace{f(x)}_{Nuisance}$$

### OLS by lm_robust (estimatr)

- robust standard errorを計算するためにestimatrパッケージ[@R-estimatr]を利用

```{r}
library(estimatr)
```

- $\tau(x)=\tau,f(x)=\beta_0+\beta_1x_1+...+\beta_Lx_L$と特定化

- サンプル内MSEを最大化するように推定

```{r}
lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married,
          data = raw)
```

#### 発展:推計結果表{-}

- tidy関数により推定結果data.frameに変化することで、kable関数(knitrパッケージ)による推計結果表の整形、geom_pointrange関数による可視化が可能

- 点推定値(estimate)、標準誤差(std.error)のみを残した推計結果表

```{r}
library(knitr)
library(tidyverse)

fit <- 
  lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married,
            data = raw)

fit <- tidy(fit)

fit <- select(fit, term, estimate, std.error)

kable(fit, digits = 2)
```

```{r}
fit <- filter(fit,
              term == "medicaidyes")
kable(fit, digits = 2)
```


#### 発展:Dot-and-Whisker plotによる可視化{-}

- Dot-and-Whisker図により点推定量と信頼区間を可視化

```{r}
fit <- 
  lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married,
            data = raw)

fit <- tidy(fit)

fit <- filter(fit,
              term != "(Intercept)")

ggplot(fit, aes(y = term,
                x = estimate,
                xmin = conf.low,
                xmax = conf.high)) +
  geom_pointrange()
```


```{r}
fit <- filter(fit,
              term == "medicaidyes")

ggplot(fit, aes(y = term,
                x = estimate,
                xmin = conf.low,
                xmax = conf.high)) +
  geom_pointrange() +
  geom_vline(xintercept = 0)
```

### Double selection

- 2重選択法[@belloni2014inference]を紹介

- hdmパッケージ[@R-hdm]を利用

```{r}
library(hdm)

Y <- raw$visits

D <- if_else(raw$medicaid == "yes", 1, 0)

X <- model.matrix(~ - 1+ age + gender + school + income + employed + region + afam + married,
                  raw)

fit <-
  rlassoEffect(x = X,
               y = Y,
               d = D,
               method = "double selection")
```

- 推定結果

```{r}
summary(fit)
```

- 選択されたコントロール変数

```{r}
fit$selection.index
```


### Double Machine Learning

- Double Machine Learning法[@chernozhukov2018double]を紹介

- DoubleMLパッケージ[@R-DoubleML]を利用

### Causal Forest

- Causal Forest法[@wager2018estimation, @athey2019generalized]を紹介

- grfパッケージ[@R-grf]を利用
