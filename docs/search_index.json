[["index.html", "Rによる比較・予測・因果推論入門 ver0.1 はじめに", " Rによる比較・予測・因果推論入門 ver0.1 川田恵介 2021-05-02 はじめに 本ページでは、定量的な比較、（反実仮想）因果推定、予測分析をRによって行う方法を紹介します。 データインポート、整理、可視化を行う関数群を統合的に提供するtidyverseパッケージ(Wickham et al. 2019)の利用を前提にします。 AERパッケージ(Kleiber and Zeileis 2008)に含まれるNMES1988を例として使用します。 無料で公開されている有力な参考文献として、以下を推薦します。 機械学習を用いた予測：James et al. (2013) 公開ページ 日本語によるR入門：私たちのR: ベストプラクティスの探究 tidyverseパッケージの利用： 公式ページ "],["intro.html", "Chapter 1 準備", " Chapter 1 準備 オフライン環境の整備 Rのインストール R studioのインストール オンライン環境の整備 R cloudへの登録 "],["識別.html", "Chapter 2 識別 2.1 予測 2.2 比較 2.3 因果効果", " Chapter 2 識別 経済学におけるデータ分析の大部分は、複数の変数間での関係性の理解・利用を目的とします。 ここではある結果変数\\(Y\\)と独立変数（群）\\(X=X_1,...,X_L\\)の関係性に焦点を当てます。 より具体的な目標は大きく（予測）\\(Y\\)の予測、（比較）異なる\\(X\\)間での\\(Y\\)の比較、（因果効果）\\(X\\)の変化が\\(Y\\)に与える因果効果 2.1 予測 2.2 比較 2.3 因果効果 "],["データ整備.html", "Chapter 3 データ整備 3.1 新しい変数の作成: mutate (tidyverse) 3.2 変数の限定: select (tidyverse) 3.3 サンプルの除外:filter (tidyverse)", " Chapter 3 データ整備 AERパッケージに含まれるNMES1988を利用 data(&quot;NMES1988&quot;, package = &quot;AER&quot;) raw &lt;- NMES1988 tidyverseパッケージに含まれるdplyrパッケージ(Wickham et al. 2021)は、有用な関数を提供 library(tidyverse) 3.1 新しい変数の作成: mutate (tidyverse) mutate関数の利用 df &lt;- mutate(raw, square_age = age^2, log_age = log(age), total_visit = visits + nvisits + ovisits + novisits ) 3.2 変数の限定: select (tidyverse) select関数の利用 df &lt;- select(raw, age, visits ) 特定の変数の除外 df &lt;- select(raw, -age, -visits ) 3.3 サンプルの除外:filter (tidyverse) filter関数の利用 df &lt;- filter(raw, visits &gt;= 5 ) "],["可視化.html", "Chapter 4 可視化 4.1 ヒストグラム: geom_histogram (tidyverse) 4.2 密度: geom_density (tidyverse) 4.3 Boxplot: geom_boxplot (tidyverse) 4.4 散布図: geom_point (tidyverse) 4.5 ヒートマップ: geom_bin2d (tidyverse)", " Chapter 4 可視化 tidyverseに含まれるggplot2パッケージ(Wickham et al. 2020)を利用 library(tidyverse) 4.1 ヒストグラム: geom_histogram (tidyverse) 医療機関の利用回数 ggplot(raw, aes(x = visits) ) + geom_histogram() メディケイド保有別の利用回数 ggplot(raw, aes(x = visits, fill = medicaid) ) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5) 男女・メディケイド保有別の利用回数 ggplot(raw, aes(x = visits, fill = medicaid) ) + geom_histogram(position = &quot;identity&quot;, alpha = 0.5 ) + facet_wrap(~ gender) 4.2 密度: geom_density (tidyverse) 男女・メディケイド保有別の利用回数 ggplot(raw, aes(x = visits, fill = medicaid) ) + geom_density(position = &quot;identity&quot;, alpha = 0.5 ) + facet_wrap(~ gender) 4.3 Boxplot: geom_boxplot (tidyverse) ggplot(raw, aes(y = visits, x = medicaid) ) + geom_boxplot() 4.4 散布図: geom_point (tidyverse) 散布図：連続変数間の関係性を可視化する図 ggplot(raw, aes(x = income, y = visits) ) + geom_point() サンプルサイズが大きくなると機能しない 4.5 ヒートマップ: geom_bin2d (tidyverse) 代替案はヒートマップ ggplot(raw, aes(x = income, y = visits) ) + geom_bin2d() "],["予測関数の推定.html", "Chapter 5 予測関数の推定 5.1 データの導入 5.2 データ分割 5.3 OLS 5.4 LASSO/Ridge 5.5 Random Forest/Bagging", " Chapter 5 予測関数の推定 5.1 データの導入 data(&quot;NMES1988&quot;, package = &quot;AER&quot;) raw &lt;- NMES1988 5.2 データ分割 ここでは5個のデータに分割する。 group &lt;- sample(1:5, size = nrow(raw), replace = TRUE) 5.3 OLS 線形予測関数\\(f(X)=\\beta_0 + \\beta_1X_1+...+\\beta_LX_L\\)を仮定し、最小二乗法にて推定する。 fit &lt;- lm(visits ~ ., data = raw[group != 1,]) coef(fit) ## (Intercept) nvisits ovisits novisits emergency ## 3.203007658 0.257426965 0.025671757 0.081666939 0.272595970 ## hospital healthpoor healthexcellent chronic adllimited ## 1.420447563 1.699851617 -1.518502376 0.817940538 0.296934997 ## regionnortheast regionmidwest regionwest age afamyes ## 0.650968188 -0.090343557 0.252677034 -0.248747417 -0.430558685 ## gendermale marriedyes school income employedyes ## -0.439803602 -0.271696992 0.104719318 -0.005527631 0.388346250 ## insuranceyes medicaidyes ## 1.231075177 1.111029460 予測値の導出 Y.hat &lt;- predict(fit,raw) テストデータへの適合 mean((raw$visits - Y.hat)[group == 1]^2) ## [1] 45.74972 訓練データへの適合 mean((raw$visits - Y.hat)[group != 1]^2) ## [1] 35.8748 5.4 LASSO/Ridge Friedman et al. (2021) 5.5 Random Forest/Bagging Wright, Wager, and Probst (2020) "],["パラメータの推定.html", "Chapter 6 パラメータの推定 6.1 データ 6.2 部分線形モデルに基づく推定", " Chapter 6 パラメータの推定 （条件付き）平均差を推定する。 点推定だけでなく、信頼区間も推定する。 6.1 データ data(&quot;NMES1988&quot;, package = &quot;AER&quot;) raw &lt;- NMES1988 6.2 部分線形モデルに基づく推定 部分線形モデルに関心のあるパラメータを埋め込む \\[E[Y|D=d,X=x]=\\underbrace{\\tau(x)}_{Interest}\\times d+\\underbrace{f(x)}_{Nuisance}\\] 6.2.1 OLS by lm_robust (estimatr) robust standard errorを計算するためにestimatrパッケージ(Blair et al. 2021)を利用 library(estimatr) \\(\\tau(x)=\\tau,f(x)=\\beta_0+\\beta_1x_1+...+\\beta_Lx_L\\)と特定化 サンプル内MSEを最大化するように推定 lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married, data = raw) ## Estimate Std. Error t value Pr(&gt;|t|) CI Lower ## (Intercept) 4.43322285 1.28909706 3.4390140 5.892654e-04 1.90594289 ## medicaidyes 1.47951835 0.37804467 3.9136072 9.230346e-05 0.73836025 ## age 0.02394287 0.15936751 0.1502368 8.805847e-01 -0.28849777 ## gendermale -0.41995637 0.22090543 -1.9010686 5.735839e-02 -0.85304235 ## school 0.13489900 0.03135497 4.3023168 1.726949e-05 0.07342746 ## income -0.03583914 0.03658309 -0.9796640 3.273060e-01 -0.10756044 ## employedyes -0.26397560 0.42442589 -0.6219592 5.340009e-01 -1.09606426 ## regionnortheast 0.40673254 0.30505181 1.3333228 1.824950e-01 -0.19132276 ## regionmidwest -0.25381796 0.25626543 -0.9904495 3.220090e-01 -0.75622737 ## regionwest 0.46017572 0.30367944 1.5153338 1.297598e-01 -0.13518905 ## afamyes -0.90212815 0.33000959 -2.7336422 6.288896e-03 -1.54911328 ## marriedyes -0.11025545 0.23160143 -0.4760569 6.340575e-01 -0.56431099 ## CI Upper DF ## (Intercept) 6.96050281 4394 ## medicaidyes 2.22067644 4394 ## age 0.33638350 4394 ## gendermale 0.01312960 4394 ## school 0.19637054 4394 ## income 0.03588216 4394 ## employedyes 0.56811305 4394 ## regionnortheast 1.00478783 4394 ## regionmidwest 0.24859145 4394 ## regionwest 1.05554048 4394 ## afamyes -0.25514302 4394 ## marriedyes 0.34380009 4394 発展:推計結果表 tidy関数により推定結果data.frameに変化することで、kable関数(knitrパッケージ)による推計結果表の整形、geom_pointrange関数による可視化が可能 点推定値(estimate)、標準誤差(std.error)のみを残した推計結果表 library(knitr) library(tidyverse) fit &lt;- lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married, data = raw) fit &lt;- tidy(fit) fit &lt;- select(fit, term, estimate, std.error) kable(fit, digits = 2) term estimate std.error (Intercept) 4.43 1.29 medicaidyes 1.48 0.38 age 0.02 0.16 gendermale -0.42 0.22 school 0.13 0.03 income -0.04 0.04 employedyes -0.26 0.42 regionnortheast 0.41 0.31 regionmidwest -0.25 0.26 regionwest 0.46 0.30 afamyes -0.90 0.33 marriedyes -0.11 0.23 fit &lt;- filter(fit, term == &quot;medicaidyes&quot;) kable(fit, digits = 2) term estimate std.error medicaidyes 1.48 0.38 発展:Dot-and-Whisker plotによる可視化 Dot-and-Whisker図により点推定量と信頼区間を可視化 fit &lt;- lm_robust(visits ~ medicaid + age + gender + school + income + employed + region + afam + married, data = raw) fit &lt;- tidy(fit) fit &lt;- filter(fit, term != &quot;(Intercept)&quot;) ggplot(fit, aes(y = term, x = estimate, xmin = conf.low, xmax = conf.high)) + geom_pointrange() fit &lt;- filter(fit, term == &quot;medicaidyes&quot;) ggplot(fit, aes(y = term, x = estimate, xmin = conf.low, xmax = conf.high)) + geom_pointrange() + geom_vline(xintercept = 0) 6.2.2 Double selection Spindler, Chernozhukov, and Hansen (2019) library(hdm) Y &lt;- raw$visits D &lt;- if_else(raw$medicaid == &quot;yes&quot;, 1, 0) X &lt;- model.matrix(~ - 1+ age + gender + school + income + employed + region + afam + married, raw) fit &lt;- rlassoEffect(x = X, y = Y, d = D, method = &quot;double selection&quot;) summary(fit) ## [1] &quot;Estimates and significance testing of the effect of target variables&quot; ## Estimate. Std. Error t value Pr(&gt;|t|) ## d1 1.4694 0.3767 3.901 9.6e-05 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 fit$selection.index ## age genderfemale gendermale school income ## FALSE TRUE FALSE TRUE TRUE ## employedyes regionnortheast regionmidwest regionwest afamyes ## TRUE FALSE TRUE TRUE TRUE ## marriedyes ## TRUE 6.2.3 Double Machine Learning Bach et al. (2021) 6.2.4 Generalized Random Forest Tibshirani, Athey, and Wager (2020) "],["references.html", "References", " References Bach, Philipp, Victor Chernozhukov, Malte S. Kurz, and Martin Spindler. 2021. DoubleML: Double Machine Learning in r. https://CRAN.R-project.org/package=DoubleML. Blair, Graeme, Jasper Cooper, Alexander Coppock, Macartan Humphreys, and Luke Sonnet. 2021. Estimatr: Fast Estimators for Design-Based Inference. https://CRAN.R-project.org/package=estimatr. Friedman, Jerome, Trevor Hastie, Rob Tibshirani, Balasubramanian Narasimhan, Kenneth Tay, and Noah Simon. 2021. Glmnet: Lasso and Elastic-Net Regularized Generalized Linear Models. https://CRAN.R-project.org/package=glmnet. James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. An Introduction to Statistical Learning. Vol. 112. Springer. Kleiber, Christian, and Achim Zeileis. 2008. Applied Econometrics with R. New York: Springer-Verlag. https://CRAN.R-project.org/package=AER. Spindler, Martin, Victor Chernozhukov, and Christian Hansen. 2019. Hdm: High-Dimensional Metrics. https://CRAN.R-project.org/package=hdm. Tibshirani, Julie, Susan Athey, and Stefan Wager. 2020. Grf: Generalized Random Forests. https://github.com/grf-labs/grf. Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain Francois, Garrett Grolemund, et al. 2019. “Welcome to the tidyverse.” Journal of Open Source Software 4 (43): 1686. https://doi.org/10.21105/joss.01686. Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, and Dewey Dunnington. 2020. Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics. https://CRAN.R-project.org/package=ggplot2. Wickham, Hadley, Romain Francois, Lionel Henry, and Kirill Muller. 2021. Dplyr: A Grammar of Data Manipulation. https://CRAN.R-project.org/package=dplyr. Wright, Marvin N., Stefan Wager, and Philipp Probst. 2020. Ranger: A Fast Implementation of Random Forests. https://github.com/imbs-hl/ranger. "]]
